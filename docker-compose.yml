  # ==================== Python Orchestrator (Replaces n8n) ====================
  
  # Orchestrator Web UI
  orchestrator-web:
    build:
      context: ./orchestrator
      dockerfile: Dockerfile
    container_name: trading-orchestrator-web
    restart: unless-stopped
    ports:
      - \"8080:8080\"
    environment:
      - COMPONENT=web
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      - CELERY_BROKER_URL=amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672/
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD}@redis:6379/0
      - VIDEO_PROCESSOR_URL=http://video-processor:8000
      - ML_SERVICE_URL=http://ml-service:8002
      - BACKTESTING_SERVICE_URL=http://backtesting-service:8001
      - OLLAMA_URL=http://ollama:11434
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=8080
    volumes:
      - ./data/videos:/data/videos:ro
      - ./data/logs:/app/logs
    depends_on:
      - postgres
      - redis
      - rabbitmq
    networks:
      - trading-network
    mem_limit: 256m
    command: python -m app.web.app
  
  # Celery Worker
  orchestrator-worker:
    build:
      context: ./orchestrator
      dockerfile: Dockerfile
    container_name: trading-orchestrator-worker
    restart: unless-stopped
    environment:
      - COMPONENT=celery-worker
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      - CELERY_BROKER_URL=amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672/
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD}@redis:6379/0
      - VIDEO_PROCESSOR_URL=http://video-processor:8000
      - ML_SERVICE_URL=http://ml-service:8002
      - BACKTESTING_SERVICE_URL=http://backtesting-service:8001
      - OLLAMA_URL=http://ollama:11434
      - USE_CASCADE=${USE_CASCADE}
      - CONFIDENCE_THRESHOLD=${CONFIDENCE_THRESHOLD}
    volumes:
      - ./data/videos:/data/videos
      - ./data/processed:/data/processed
      - ./data/logs:/app/logs
    depends_on:
      - postgres
      - redis
      - rabbitmq
    networks:
      - trading-network
    mem_limit: 512m
    command: celery -A app.celery_app worker --loglevel=info --concurrency=2
  
  # Celery Beat (Scheduler)
  orchestrator-beat:
    build:
      context: ./orchestrator
      dockerfile: Dockerfile
    container_name: trading-orchestrator-beat
    restart: unless-stopped
    environment:
      - COMPONENT=celery-beat
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      - CELERY_BROKER_URL=amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672/
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD}@redis:6379/0
      - BATCH_SCHEDULE_HOUR=${BATCH_SCHEDULE_HOUR:-2}
      - BATCH_SIZE=${BATCH_SIZE:-10}
    depends_on:
      - postgres
      - redis
      - rabbitmq
    networks:
      - trading-network
    mem_limit: 128m
    command: celery -A app.celery_app beat --loglevel=info
  
  # File Watcher
  orchestrator-watcher:
    build:
      context: ./orchestrator
      dockerfile: Dockerfile
    container_name: trading-orchestrator-watcher
    restart: unless-stopped
    environment:
      - COMPONENT=file-watcher
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      - CELERY_BROKER_URL=amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672/
      - VIDEO_WATCH_DIR=/data/videos
      - ENABLE_FILE_WATCHER=${ENABLE_FILE_WATCHER:-true}
    volumes:
      - ./data/videos:/data/videos
      - ./data/logs:/app/logs
    depends_on:
      - orchestrator-worker
    networks:
      - trading-network
    mem_limit: 128m
    command: python -m app.file_watcher